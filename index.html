<!doctype html>
<html>
  <head>
    <title>demo</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #F0F0F0;
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="https://cdn.rawgit.com/konvajs/konva/1.3.0/konva.js"></script>
  </head>
  <body>
    
    <div id="container"></div>
    <script type="text/javascript">

      $(() => {
        var socket;
        socket = io({transports: ['websocket']});

        var width = window.innerWidth;
        var height = window.innerHeight;
        var star;

        var tween = null;

        var stage = new Konva.Stage({
          container: 'container',
          width: width,
          height: height
        });

        var layer = new Konva.Layer();
        var dragLayer = new Konva.Layer();

        var scale = 1;

        var imageObj = new Image();
        imageObj.onload = () => {
          star = new Konva.Image({
            x: 400,
            y: 400,
            image: imageObj,
            width: 600,
            height: 600,
            draggable: true,
            offset: {
              x: 300,
              y: 300
            }
          });

          star.on('dragmove', (evt) => {
            console.log('evt', {x: evt.target.attrs.x, y: evt.target.attrs.y});
            socket.emit('evt', {x: evt.target.attrs.x, y: evt.target.attrs.y});
          })

          // add the shape to the layer
          layer.add(star);
          // add the layer to the stage
          //stage.add(layer);
          stage.draw();

          stage.add(layer, dragLayer);

          

        };

        imageObj.src = '/spinner.png';

        

        //layer.add(star);

        


        
        

        socket.on('evt', function(msg){
          console.log('evt received', msg);
          /*
          star.setAttrs({
            x: msg.x,
            y: msg.y
          })
          */

          var angularSpeed = 90;

          var anim = new Konva.Animation(function(frame) {
              var angleDiff = frame.timeDiff * angularSpeed / 1000;
              star.rotate(angleDiff);

          }, layer);
    
          anim.start();

          setTimeout(()=> {
            anim.stop();
          }, 3000);

          //stage.draw();
        });

          
        
        
      });
      
      

    </script>
  </body>
</html>